# syntax=docker/dockerfile:experimental
FROM node:15.14.0-stretch as base
SHELL ["/bin/bash", "--login", "-c"]

WORKDIR /app
RUN npm install -g serve

EXPOSE 8081

COPY webapp/package.json webapp/yarn.lock ./

FROM base as development
RUN --mount=type=cache,target=/root/.cache/yarn yarn install
CMD [ "yarn", "serve", "--port", "8081"]

FROM base as production

ENV NODE_ENV production
RUN --mount=type=cache,target=/root/.cache/yarn yarn install --prod
COPY webapp ./
RUN yarn build
CMD [ "serve", "-s", "dist", "-p", "8081" ]
